<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>도토리 농장</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Jua', sans-serif; overflow: hidden; background-color: #d1fae5; display: flex; align-items: center; justify-content: center; height: 100vh; }
        canvas { display: block; }
        .popup-enter { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        .blinking { animation: blink 1.5s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }
    </style>
</head>
<body class="p-2 sm:p-4">
    
    <div class="w-full max-w-sm mx-auto h-full max-h-[95vh] sm:max-h-[800px] flex flex-col">
        <div class="w-full bg-white rounded-3xl shadow-2xl overflow-hidden flex flex-col flex-grow min-h-0">
            <header class="p-3 sm:p-4 bg-emerald-500 text-white text-center rounded-t-3xl flex-shrink-0">
                <h1 class="text-2xl sm:text-3xl font-bold">도토리 농장</h1>
                <div class="flex justify-between items-center mt-1 sm:mt-2 text-sm sm:text-lg">
                    <div>최고점수: <span id="high-score">0</span></div>
                    <div>현재점수: <span id="current-score">0</span></div>
                </div>
            </header>
            <div class="bg-emerald-200 p-2 flex items-center justify-center space-x-4 flex-shrink-0">
                <span class="text-slate-700">다음 물체:</span>
                <div id="next-item-display" class="w-10 h-10 sm:w-12 sm:h-12 flex items-center justify-center bg-white rounded-full shadow-inner">
                    <span id="next-item-emoji" class="text-2xl sm:text-3xl"></span>
                </div>
            </div>
            <div id="game-container" class="relative flex-grow min-h-0">
                <div id="game-over-modal" class="hidden absolute inset-0 bg-black bg-opacity-60 flex-col items-center justify-center text-center p-8 z-50 popup-enter">
                    <!-- Game over content is dynamically added -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Popups -->
    <div id="discovery-popup" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-[100] popup-enter">
        <div class="bg-gradient-to-br from-lime-200 to-green-300 rounded-3xl p-6 text-center shadow-2xl max-w-sm w-full border-4 border-white">
            <h2 class="text-3xl font-bold text-green-700 mb-2">✨ 새로운 발견! ✨</h2>
            <div id="popup-emoji" class="text-8xl my-4 animate-bounce"></div>
            <h3 id="popup-name" class="text-4xl font-bold text-slate-800"></h3>
            <p id="popup-description" class="text-slate-600 mt-2 mb-6 text-lg"></p>
            <button id="popup-close-button" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-8 rounded-full text-xl shadow-lg">계속하기</button>
        </div>
    </div>
    <div id="game-complete-popup" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-[100] popup-enter">
        <div class="bg-gradient-to-br from-lime-300 to-emerald-400 rounded-3xl p-6 text-center shadow-2xl max-w-sm w-full border-4 border-white">
            <h2 class="text-4xl font-bold text-white mb-2">🎉 도감 완성! 🎉</h2>
            <div class="text-8xl my-4 animate-bounce">🏠</div>
            <h3 class="text-3xl font-bold text-white">모든 물체를 완성했어요!</h3>
            <p class="text-white mt-2 mb-6 text-lg">당신은 최고의 농장 마스터입니다!</p>
            <button id="complete-popup-close-button" class="bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-3 px-8 rounded-full text-xl shadow-lg">계속 도전하기</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, limit, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const { Engine, Render, Runner, World, Bodies, Common, Events, Body, Composite } = Matter;

        // Firebase Setup
        let db, auth;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        async function setupFirebase() {
            try {
                const firebaseConfig = JSON.parse(__firebase_config);
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                console.log("Firebase initialized and user signed in.");
                init(); // Start game after Firebase setup
            } catch (error) {
                console.error("Firebase initialization error:", error);
                // Continue with game initialization even without Firebase
                init();
            }
        }


        // --- Rest of the game code ---
        const gameContainer = document.getElementById('game-container');
        let containerWidth, containerHeight;
        
        const highScoreEl = document.getElementById('high-score');
        const currentScoreEl = document.getElementById('current-score');
        const nextItemEmojiEl = document.getElementById('next-item-emoji');
        
        const gameOverModal = document.getElementById('game-over-modal');
        const discoveryPopup = document.getElementById('discovery-popup');
        const popupEmoji = document.getElementById('popup-emoji');
        const popupName = document.getElementById('popup-name');
        const popupDescription = document.getElementById('popup-description');
        const popupCloseButton = document.getElementById('popup-close-button');
        const gameCompletePopup = document.getElementById('game-complete-popup');
        const completePopupCloseButton = document.getElementById('complete-popup-close-button');

        let ITEMS;
        const MAX_LEVEL = 3;
        const MAX_SPAWN_LEVEL = 2;

        let engine, render, runner;
        let currentScore = 0;
        let highScore = localStorage.getItem('acorn-farm-highscore') || 0;
        let discoveredItems = JSON.parse(localStorage.getItem('discoveredItems')) || [0];
        let isGameOver = false;
        let currentItem = null;
        let nextItemInfo = null;
        let disableAction = false;
        let isAudioStarted = false;
        let isFirstItem = true;
        
        let bodiesToRemove = new Set();
        let bodiesToAdd = [];

        // Sound settings
        const bgmSynth = new Tone.FMSynth({ harmonicity: 1.5, modulationIndex: 10, oscillator: { type: "triangle" }, envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 0.1 }, modulation: { type: "sawtooth" }, modulationEnvelope: { attack: 0.1, decay: 0.1, sustain: 0.5, release: 0.1 } }).toDestination();
        bgmSynth.volume.value = -15;
        const bgmPattern = new Tone.Sequence((time, note) => { bgmSynth.triggerAttackRelease(note, "16n", time); }, ['C2', 'G2', 'C3', 'G2', 'C2', 'D#2', 'C2', 'D#2']).start(0);
        bgmPattern.loop = true;
        const melodySynth = new Tone.AMSynth({ envelope: { attack: 0.01, decay: 0.1, sustain: 0.2, release: 0.1 } }).toDestination();
        melodySynth.volume.value = -10;
        const melodyPattern = new Tone.Sequence((time, note) => { melodySynth.triggerAttackRelease(note, '8n', time); }, ['G4', 'A#4', 'C5', 'A#4', null, 'G4', 'F4', 'G4']).start("0:2");
        melodyPattern.loop = true;
        Tone.Transport.bpm.value = 140;
        const sfxSynth = new Tone.PolySynth(Tone.Synth).toDestination();
        const dropSound = () => sfxSynth.triggerAttackRelease("C4", "8n");
        const mergeSound = (level) => sfxSynth.triggerAttackRelease(440 * Math.pow(2, (level - 4) / 12), "8n");
        const discoverySound = () => { const now = Tone.now(); sfxSynth.triggerAttackRelease("C5", "8n", now); sfxSynth.triggerAttackRelease("E5", "8n", now + 0.1); sfxSynth.triggerAttackRelease("G5", "8n", now + 0.2); };
        const completeSound = () => { const now = Tone.now(); sfxSynth.triggerAttackRelease("C5", "8n", now); sfxSynth.triggerAttackRelease("G5", "8n", now + 0.2); sfxSynth.triggerAttackRelease("C6", "8n", now + 0.4); };
        const gameOverSound = () => { const now = Tone.now(); sfxSynth.triggerAttackRelease("C4", "8n", now); sfxSynth.triggerAttackRelease("G3", "8n", now + 0.2); sfxSynth.triggerAttackRelease("E3", "8n", now + 0.4); };

        function showDiscoveryPopup(level) {
            const item = ITEMS[level];
            if (!item) return;
            disableAction = true; Runner.stop(runner); if (isAudioStarted) Tone.Transport.pause();
            popupEmoji.textContent = item.emoji; popupName.textContent = item.name; popupDescription.textContent = item.description;
            discoveryPopup.classList.remove('hidden'); discoverySound();
        }
        function showGameCompletePopup() {
            disableAction = true; Runner.stop(runner); if (isAudioStarted) Tone.Transport.pause();
            gameCompletePopup.classList.remove('hidden'); completeSound();
        }
        popupCloseButton.addEventListener('click', () => {
            discoveryPopup.classList.add('hidden'); Runner.run(runner, engine); if (isAudioStarted) Tone.Transport.start();
            setTimeout(() => { if (!isGameOver) { spawnCurrentItem(); disableAction = false; } }, 100); 
        });
        completePopupCloseButton.addEventListener('click', () => {
             gameCompletePopup.classList.add('hidden'); Runner.run(runner, engine); if (isAudioStarted) Tone.Transport.start();
             setTimeout(() => { if (!isGameOver) { spawnCurrentItem(); disableAction = false; } }, 100);
        });

        function init() {
            containerWidth = gameContainer.clientWidth; containerHeight = gameContainer.clientHeight;
            ITEMS = [
                { level: 0, name: '도토리', radius: containerWidth * 0.08, score: 1, emoji: '🌰', color: '#8b5e3c', description: '작고 귀여운 도토리. 농장의 첫 시작이예요!' },
                { level: 1, name: '닭', radius: containerWidth * 0.12, score: 3, emoji: '🐔', color: '#ffb56b', description: '꼬꼬댁! 도토리 두 개가 합쳐져서 닭이 되었어요.' },
                { level: 2, name: '소', radius: containerWidth * 0.15, score: 6, emoji: '🐄', color: '#f5f5f5', description: '음메-! 닭 두 마리가 합쳐지면 튼튼한 소가 됩니다.' },
                { level: 3, name: '집', radius: containerWidth * 0.2, score: 10, emoji: '🏠', color: '#c29b7a', description: '축하해요! 소 두 마리가 모여서 멋진 집을 지었어요!' }
            ];
            if (engine) World.clear(engine.world, false); if (render) Render.stop(render); if (runner) Runner.stop(runner); if (render && render.canvas) render.canvas.remove();
            bodiesToRemove.clear(); bodiesToAdd = []; isFirstItem = true;
            engine = Engine.create(); engine.world.gravity.y = 1;
            render = Render.create({ element: gameContainer, engine: engine, options: { width: containerWidth, height: containerHeight, wireframes: false, background: 'transparent' } });
            runner = Runner.create(); Runner.run(runner, engine); Render.run(render, engine);
            currentScore = 0; isGameOver = false; disableAction = false; updateScores(); gameOverModal.classList.add('hidden');
            createBoundaries(); prepareNextItem(); spawnCurrentItem(); setupEventListeners();
            if (isAudioStarted) Tone.Transport.start();
        }
        function createBoundaries() {
            const wallOptions = { isStatic: true, render: { fillStyle: '#34d399' } };
            World.add(engine.world, [ Bodies.rectangle(containerWidth / 2, containerHeight, containerWidth, 50, wallOptions), Bodies.rectangle(10, containerHeight / 2, 20, containerHeight, wallOptions), Bodies.rectangle(containerWidth - 10, containerHeight / 2, 20, containerHeight, wallOptions) ]);
        }
        function addItem(x, y, level) {
            if (level > MAX_LEVEL) return null;
            const itemInfo = ITEMS[level];
            const item = Bodies.circle(x, y, itemInfo.radius, { label: `item_${level}`, restitution: 0.3, friction: 0.5, render: { fillStyle: itemInfo.color } });
            if (!discoveredItems.includes(level)) {
                discoveredItems.push(level); localStorage.setItem('discoveredItems', JSON.stringify(discoveredItems));
                if (level === MAX_LEVEL) { showGameCompletePopup(); } else { showDiscoveryPopup(level); }
            }
            World.add(engine.world, item); return item;
        }
        function prepareNextItem() {
            let spawnableLevels = discoveredItems.filter(level => level <= MAX_SPAWN_LEVEL); if (spawnableLevels.length === 0) spawnableLevels = [0];
            const randomLevel = isFirstItem ? 0 : spawnableLevels[Math.floor(Math.random() * spawnableLevels.length)];
            nextItemInfo = ITEMS[randomLevel]; nextItemEmojiEl.textContent = nextItemInfo.emoji; nextItemEmojiEl.style.fontSize = `${containerWidth * 0.05 * 1.5}px`;
        }
        function spawnCurrentItem() {
            if (isGameOver || currentItem) return; 
            currentItem = addItem(containerWidth / 2, 50, nextItemInfo.level); if(currentItem) Body.setStatic(currentItem, true); prepareNextItem();
        }
        function setupEventListeners() {
            const handleMove = (e) => {
                if (!currentItem || isGameOver || disableAction) return; e.preventDefault();
                let x = e.offsetX; if (e.touches) x = e.touches[0].clientX - gameContainer.getBoundingClientRect().left;
                const radius = ITEMS[parseInt(currentItem.label.split('_')[1])].radius; const clampedX = Common.clamp(x, radius + 10, containerWidth - radius - 10);
                Body.setPosition(currentItem, { x: clampedX, y: currentItem.position.y });
            };
            const handleDrop = async () => {
                if (!currentItem || isGameOver || disableAction) return;
                if (!isAudioStarted) { await Tone.start(); Tone.Transport.start(); isAudioStarted = true; }
                Body.setStatic(currentItem, false); dropSound(); if (isFirstItem) isFirstItem = false;
                disableAction = true; currentItem = null;
                setTimeout(() => { if (discoveryPopup.classList.contains('hidden') && gameCompletePopup.classList.contains('hidden')) { spawnCurrentItem(); disableAction = false; } }, 800);
            };
            gameContainer.addEventListener('mousemove', handleMove); gameContainer.addEventListener('touchmove', handleMove, { passive: false }); gameContainer.addEventListener('mousedown', handleDrop); gameContainer.addEventListener('touchend', handleDrop);
            Events.on(engine, 'collisionStart', handleCollision); Events.on(engine, 'afterUpdate', processDeferredActions); Events.on(render, 'afterRender', afterRender);
        }
        function processDeferredActions() {
            if(isGameOver) return;
            if (bodiesToRemove.size > 0) { bodiesToRemove.forEach(body => World.remove(engine.world, body)); bodiesToRemove.clear(); }
            if (bodiesToAdd.length > 0) { bodiesToAdd.forEach(data => addItem(data.x, data.y, data.level)); bodiesToAdd = []; }
        }
        let gameOverCheckTimeout = null;
        function afterRender() {
            const bodies = Composite.allBodies(engine.world); const context = render.context; let isAboveLine = false;
            bodies.forEach(body => {
                if (body.label && body.label.startsWith('item_')) {
                    const level = parseInt(body.label.split('_')[1]); const itemInfo = ITEMS[level];
                    context.font = `${itemInfo.radius * 1.5}px Jua`; context.textAlign = "center"; context.textBaseline = "middle"; context.fillStyle = '#000000'; context.fillText(itemInfo.emoji, body.position.x, body.position.y);
                    if (!body.isStatic && body.position.y - body.circleRadius < 100) { isAboveLine = true; }
                }
            });
            context.beginPath(); context.moveTo(0, 100); context.lineTo(containerWidth, 100); context.strokeStyle = 'rgba(255, 0, 0, 0.5)'; context.lineWidth = 2; context.setLineDash([5, 5]); context.stroke(); context.setLineDash([]);
            if (isAboveLine && !isGameOver) {
                if (!gameOverCheckTimeout) {
                    gameOverCheckTimeout = setTimeout(() => {
                        const bodiesNow = Composite.allBodies(engine.world); let stillAbove = false;
                        bodiesNow.forEach(body => { if (body.label && body.label.startsWith('item_') && !body.isStatic && body.position.y - body.circleRadius < 100) { stillAbove = true; } });
                        if (stillAbove) triggerGameOver();
                        gameOverCheckTimeout = null;
                    }, 1000);
                }
            } else if (!isAboveLine && gameOverCheckTimeout) { clearTimeout(gameOverCheckTimeout); gameOverCheckTimeout = null; }
        }
        function handleCollision(event) {
            if (isGameOver) return; const pairs = event.pairs;
            for (const pair of pairs) {
                const { bodyA, bodyB } = pair;
                if (!bodyA.label || !bodyB.label || bodiesToRemove.has(bodyA) || bodiesToRemove.has(bodyB)) continue;
                if (bodyA.label === bodyB.label && bodyA.label.startsWith('item_')) {
                    const level = parseInt(bodyA.label.split('_')[1]); if (level >= MAX_LEVEL) continue;
                    bodiesToRemove.add(bodyA); bodiesToRemove.add(bodyB);
                    bodiesToAdd.push({ x: (bodyA.position.x + bodyB.position.x) / 2, y: (bodyA.position.y + bodyB.position.y) / 2, level: level + 1 });
                    currentScore += ITEMS[level].score; updateScores(); mergeSound(level + 1);
                }
            }
        }
        
        async function triggerGameOver() {
            if(isGameOver) return; isGameOver = true;
            Runner.stop(runner); gameOverSound(); if (isAudioStarted) Tone.Transport.stop();
            
            if (!db) {
                showSimpleGameOver();
                return;
            }

            const leaderboardRef = collection(db, `artifacts/${appId}/public/data/leaderboard`);
            const q = query(leaderboardRef, orderBy("score", "desc"), limit(10));
            const querySnapshot = await getDocs(q);
            
            let leaderboard = [];
            querySnapshot.forEach((doc) => {
                leaderboard.push({ id: doc.id, ...doc.data() });
            });

            const isTopTen = leaderboard.length < 10 || currentScore > leaderboard[leaderboard.length - 1].score;

            if (isTopTen) {
                showNameInput(leaderboard);
            } else {
                showLeaderboard(leaderboard);
            }
        }

        function showSimpleGameOver() {
            gameOverModal.innerHTML = `<h2 class="text-5xl font-bold text-red-500 mb-4">게임 종료!</h2><p class="text-2xl text-white mb-2">최종 점수</p><p class="text-6xl font-bold text-yellow-300 mb-8">${currentScore}</p><button id="restart-button-simple" class="bg-yellow-400 hover:bg-yellow-500 text-slate-800 font-bold py-3 px-8 rounded-full text-2xl shadow-lg">다시 하기</button>`;
            gameOverModal.classList.remove('hidden');
            document.getElementById('restart-button-simple').addEventListener('click', init);
        }
        
        function showNameInput(leaderboard) {
            gameOverModal.innerHTML = `
                <h2 class="text-4xl font-bold text-yellow-300 mb-2 blinking">🎉 TOP 10 달성! 🎉</h2>
                <p class="text-xl text-white mb-4">랭킹에 이름을 남겨주세요!</p>
                <p class="text-5xl font-bold text-white mb-6">${currentScore}점</p>
                <input type="text" id="name-input" placeholder="이름 (최대 10자)" maxlength="10" class="text-center text-xl p-2 rounded-md w-full mb-4 text-slate-800">
                <button id="submit-score-button" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-8 rounded-full text-2xl shadow-lg">등록하기</button>
            `;
            gameOverModal.classList.remove('hidden');
            
            const nameInput = document.getElementById('name-input');
            document.getElementById('submit-score-button').addEventListener('click', async () => {
                const name = nameInput.value.trim() || "이름없음";
                await saveScoreToLeaderboard(name, currentScore, leaderboard);
            });
        }

        async function saveScoreToLeaderboard(name, score, leaderboard) {
            const leaderboardRef = collection(db, `artifacts/${appId}/public/data/leaderboard`);
            await addDoc(leaderboardRef, { name, score, createdAt: new Date() });

            if (leaderboard.length >= 10) {
                const lowestScoreDocId = leaderboard[leaderboard.length - 1].id;
                await deleteDoc(doc(db, `artifacts/${appId}/public/data/leaderboard`, lowestScoreDocId));
            }
            
            const updatedQuerySnapshot = await getDocs(query(leaderboardRef, orderBy("score", "desc"), limit(10)));
            const updatedLeaderboard = [];
            updatedQuerySnapshot.forEach((doc) => {
                updatedLeaderboard.push({ id: doc.id, ...doc.data() });
            });
            showLeaderboard(updatedLeaderboard, auth.currentUser.uid + score); // Temporary ID for highlighting
        }

        function showLeaderboard(leaderboard, highlightId = null) {
            let leaderboardHtml = `<h2 class="text-4xl font-bold text-yellow-300 mb-4">🏆 명예의 전당 🏆</h2><div class="w-full text-left space-y-2 mb-6">`;
            leaderboard.forEach((entry, index) => {
                const isHighlight = highlightId && entry.id === highlightId;
                leaderboardHtml += `
                    <div class="flex justify-between items-center p-2 rounded-md ${isHighlight ? 'bg-yellow-400 text-slate-800' : 'bg-white/20 text-white'}">
                        <span class="font-bold text-lg">${index + 1}. ${entry.name}</span>
                        <span class="text-lg">${entry.score}점</span>
                    </div>
                `;
            });
            leaderboardHtml += `</div><button id="restart-button-leaderboard" class="bg-yellow-400 hover:bg-yellow-500 text-slate-800 font-bold py-3 px-8 rounded-full text-2xl shadow-lg">다시 하기</button>`;
            
            gameOverModal.innerHTML = leaderboardHtml;
            gameOverModal.classList.remove('hidden');
            document.getElementById('restart-button-leaderboard').addEventListener('click', init);
        }

        function updateScores() {
            currentScoreEl.textContent = currentScore;
            if (currentScore > highScore) {
                highScore = currentScore; localStorage.setItem('acorn-farm-highscore', highScore);
            }
            highScoreEl.textContent = highScore;
        }
        
        window.addEventListener('resize', () => { clearTimeout(window.resizeTimeout); window.resizeTimeout = setTimeout(init, 250); });
        
        // Start game with Firebase setup
        setupFirebase();
    </script>
</body>
</html>
